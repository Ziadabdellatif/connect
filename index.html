<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…ÙŠÙ„</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { margin: 0; font-family: 'Tajawal', sans-serif; background: #f7f9fb; color: #2e2e2e; }
    .container { max-width: 720px; margin: 2rem auto; background: #fff; border-radius: 16px; padding: 2rem; box-shadow: 0 0 15px rgba(0,0,0,0.08); }
    .logo { text-align: center; margin-bottom: 1rem; }
    .logo img { max-width: 120px; border-radius: 50%; border: 2px solid #eee; }
    h2 { text-align: center; margin-bottom: 2rem; color: #3b3b3b; }
    label { display: block; margin-top: 1rem; font-weight: bold; }
    input, select, textarea {
      width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #ccc;
      margin-top: 0.3rem; margin-bottom: 0.7rem; background: #f9f9f9;
    }
    input:read-only {
      background: #e9ecef; color: #6c757d; cursor: not-allowed;
    }
    button { width: 100%; padding: 0.9rem; background: #3b7a57; border: none;
      color: #fff; font-size: 1rem; border-radius: 10px; cursor: pointer; margin-top: 1rem;
    }
    .show-leads-btn {
      background: #17a2b8; margin-top: 2rem; display: none;
    }
    .show-leads-btn:hover { background: #138496; }
    .modal { display: none; position: fixed; left: 0; top: 0;
      width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;
    }
    .modal-content {
      background: #fff; margin: 15% auto; padding: 2rem;
      max-width: 450px; border-radius: 12px; text-align: center; font-weight: bold;
    }
    .modal-content::before { content: 'âœ”ï¸'; font-size: 2rem; color: green; display: block; margin-bottom: 0.5rem; }
    .modal-content.error { color: #c0392b; }
    .modal-content.error::before { content: 'âŒ'; color: #c0392b; }
    .verification-modal .modal-content::before { content: 'âš ï¸'; color: #ff9800; }
    .verification-modal .modal-content { color: #333; }
    .modal-buttons { margin-top: 1.5rem; }
    .modal-buttons button {
      margin: 0 0.5rem; padding: 0.7rem 1.5rem; border: none; border-radius: 8px;
      cursor: pointer; font-weight: bold; width: auto;
    }
    .confirm-btn { background: #28a745; color: white; }
    .cancel-btn { background: #dc3545; color: white; }
    .phone-warning, .locked-message { color: red; font-size: 0.85rem; display: none; }
    .leads-table { width: 100%; border-collapse: collapse; margin-top: 2rem; }
    .leads-table th, .leads-table td { border: 1px solid #ddd; padding: 0.6rem; text-align: center; }
    .leads-table th { background: #f0f0f0; }
    #leadsTableContainer { margin-top: 2rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo"><img src="https://iili.io/FuT8Alt.png" alt="Logo"></div>
    <h2>Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>
    <form id="leadForm">
      <label for="referrerName">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ÙˆÙ‚</label>
      <input type="text" id="referrerName" required>
      <label for="referrerPhone">Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ÙˆÙ‚</label>
      <input type="tel" id="referrerPhone" required>
      <div id="refPhoneWarning" class="phone-warning">âš ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø±Ù‚Ù… Ø¨Ù€ 01 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 11 Ø±Ù‚Ù…Ù‹Ø§</div>
      <div id="lockNotice" class="locked-message">â— Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù….</div>
      <label for="clientName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
      <input type="text" id="clientName" required>
      <label for="clientPhone">Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
      <input type="tel" id="clientPhone" required>
      <div id="clientPhoneWarning" class="phone-warning">âš ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø±Ù‚Ù… Ø¨Ù€ 01 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 11 Ø±Ù‚Ù…Ù‹Ø§</div>
      <label for="propertyType">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±</label>
      <select id="propertyType" required>
        <option disabled selected>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±</option>
        <option>Ø´Ù‚Ø©</option><option>Ø£Ø±Ø¶</option><option>Ø´Ø§Ù„ÙŠÙ‡</option>
        <option>ÙÙŠÙ„Ø§</option><option>Ø¯ÙˆØ¨Ù„ÙƒØ³</option><option>ØªØ¬Ø§Ø±ÙŠ</option>
      </select>
      <label for="areaCity">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© / Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
      <input type="text" id="areaCity" required>
      <label for="unitCode">ÙƒÙˆØ¯ Ø§Ù„ÙˆØ­Ø¯Ø©</label>
      <input type="text" id="unitCode" required>
      <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea id="notes" rows="3"></textarea>
      <button type="submit">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </form>
    
    <button id="showLeadsBtn" class="show-leads-btn">ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</button>
    <div id="leadsTableContainer"></div>
  </div>
  
  <!-- Success Modal -->
  <div class="modal" id="successModal">
    <div class="modal-content">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­</div>
  </div>
  
  <!-- Error Modal -->
  <div class="modal" id="errorModal">
    <div class="modal-content error">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù….</div>
  </div>
  
  <!-- Verification Modal -->
  <div class="modal verification-modal" id="verificationModal">
    <div class="modal-content">
      <p><strong>ØªØ£ÙƒÙŠØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ÙˆÙ‚</strong></p>
      <p>âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
      <div id="verificationData" style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px; text-align: right;"></div>
      <p><strong style="color: #dc3545;">Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù† ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯!</strong></p>
      <div class="modal-buttons">
        <button class="confirm-btn" id="confirmData">âœ… ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„</button>
        <button class="cancel-btn" id="cancelData">âŒ Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>
  
  <script>
    // Ø¥Ø¶Ø§ÙØ© Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù„ÙŠØ¯Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
    let leadsStorage = [];

    // Global error handlers
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
    });
    
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      event.preventDefault();
    });
    
    const form = document.getElementById('leadForm');
    const nameInput = form.referrerName;
    const phoneInput = form.referrerPhone;
    const lockNotice = document.getElementById('lockNotice');
    const phoneWarning = document.getElementById('refPhoneWarning');
    const leadsTableContainer = document.getElementById('leadsTableContainer');
    const showLeadsBtn = document.getElementById('showLeadsBtn');
    const endpoint = 'https://script.google.com/macros/s/AKfycbyT8o2WxNZr3tqSJ8DR76DzvoGfV1tNBkhFiE7mYnSsohM9WeAaYP2RbBbYLbhz8lO5/exec';
    
    let marketerDataLocked = false;
    let pendingSubmissionData = null;
    
    function validatePhone(phone) { 
      return /^01\d{9}$/.test(phone.trim()); 
    }
    
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.style.display = 'block';
      if (modalId !== 'verificationModal') {
        setTimeout(() => { modal.style.display = 'none'; }, 2500);
      }
    }
    
    function hideModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    // Real-time validation for client phone
    document.getElementById('clientPhone').addEventListener('input', () => {
      document.getElementById('clientPhoneWarning').style.display = 
        validatePhone(form.clientPhone.value) ? 'none' : 'block';
    });
    
    // Real-time validation for referrer phone
    phoneInput.addEventListener('input', () => {
      if (!marketerDataLocked) {
        phoneWarning.style.display = validatePhone(phoneInput.value) ? 'none' : 'block';
      }
    });
    
    // Handle click on locked inputs
    function handleLockedInputClick(inputElement) {
      if (marketerDataLocked) {
        lockNotice.style.display = 'block';
        setTimeout(() => {
          lockNotice.style.display = 'none';
        }, 3000);
      }
    }
    
    nameInput.addEventListener('click', () => handleLockedInputClick(nameInput));
    phoneInput.addEventListener('click', () => handleLockedInputClick(phoneInput));
    
    // Show leads button functionality
    showLeadsBtn.addEventListener('click', () => {
      if (marketerDataLocked) {
        fetchLeads(phoneInput.value.trim());
      }
    });
    
    // Verification modal handlers
    document.getElementById('confirmData').addEventListener('click', async () => {
      hideModal('verificationModal');
      await submitData(pendingSubmissionData);
    });
    
    document.getElementById('cancelData').addEventListener('click', () => {
      hideModal('verificationModal');
      pendingSubmissionData = null;
    });
    
    // Form submission handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const refName = nameInput.value.trim();
      const refPhone = phoneInput.value.trim();
      const clientPhone = form.clientPhone.value.trim();
      
      // Validate referrer phone
      if (!validatePhone(refPhone)) { 
        phoneWarning.style.display = 'block'; 
        return; 
      }
      
      // Validate client phone
      if (!validatePhone(clientPhone)) {
        document.getElementById('clientPhoneWarning').style.display = 'block'; 
        return;
      }
      
      // Hide warnings if validation passes
      phoneWarning.style.display = 'none';
      document.getElementById('clientPhoneWarning').style.display = 'none';
      
      const data = {
        timestamp: new Date().toISOString(),
        referrerName: refName,
        referrerPhone: refPhone,
        clientName: form.clientName.value.trim(),
        clientPhone: clientPhone,
        propertyType: form.propertyType.value,
        areaCity: form.areaCity.value.trim(),
        unitCode: form.unitCode.value.trim(),
        notes: form.notes.value.trim()
      };
      
      // If marketer data is not locked yet, show verification modal
      if (!marketerDataLocked) {
        document.getElementById('verificationData').innerHTML = `
          <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ÙˆÙ‚:</strong> ${refName}</p>
          <p><strong>Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ÙˆÙ‚:</strong> ${refPhone}</p>
        `;
        pendingSubmissionData = data;
        showModal('verificationModal');
      } else {
        // If already locked, submit directly
        await submitData(data);
      }
    });
    
    async function submitData(data) {
      try {
        console.log('Sending data:', data);
        
        const response = await fetch(endpoint, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
        
        console.log('Data sent successfully');

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ leadsStorage
        leadsStorage.push(data);

        // Wait a moment before showing success to ensure data is processed
        setTimeout(() => {
          // Lock marketer data after first successful submission
          if (!marketerDataLocked) {
            marketerDataLocked = true;
            nameInput.readOnly = true;
            phoneInput.readOnly = true;
            showLeadsBtn.style.display = 'block';
          }
          
          lockNotice.style.display = 'none';
          showModal("successModal");
          
          // Reset form but keep marketer info
          const tempRefName = nameInput.value;
          const tempRefPhone = phoneInput.value;
          form.reset();
          nameInput.value = tempRefName;
          phoneInput.value = tempRefPhone;
          
          // Clear pending data
          pendingSubmissionData = null;
        }, 500);
        
      } catch (error) { 
        console.error('Error sending data:', error);
        showModal("errorModal");
      }
    }
    
    async function fetchLeads(phone) {
      if (!phone || !validatePhone(phone)) {
        leadsTableContainer.innerHTML = '<p style="color: red;">âš ï¸ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­</p>';
        return;
      }
      
      leadsTableContainer.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</p>';
      
      try {
        console.log('Fetching leads for phone:', phone);
        
        // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠØ¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ leadsStorage
        const leads = leadsStorage.filter(lead => lead.referrerPhone === phone);
        
        if (leads.length === 0) {
          leadsTableContainer.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯. <br><small>ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ… Ø­ÙØ¸Ù‡Ø§ Ù…Ø³Ø¨Ù‚Ù‹Ø§.</small></p>';
          return;
        }
        
        let html = '<h3>ğŸ“‹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ù„Ù„Ù…Ø³ÙˆÙ‚: ' + nameInput.value + '</h3>';
        html += '<table class="leads-table"><thead><tr>' +
                 '<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¹Ù‚Ø§Ø±</th>' +
                 '<th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>' +
                 '</tr></thead><tbody>';
        
        leads.forEach(lead => {
          html += `<tr>
            <td><strong>${new Date(lead.timestamp).toLocaleString('ar-EG')}</strong></td>
            <td>${lead.clientName || ''}</td>
            <td>${lead.clientPhone || ''}</td>
            <td>${lead.propertyType || ''}</td>
            <td>${lead.areaCity || ''}</td>
            <td>${lead.unitCode || ''}</td>
            <td><strong style="color: #28a745;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</strong></td>
          </tr>`;
        });
        
        html += '</tbody></table>';
        leadsTableContainer.innerHTML = html;
        
      } catch (error) { 
        console.error('Error fetching leads:', error);
        leadsTableContainer.innerHTML = '<p style="color: red;">âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>'; 
      }
    }
    
    // Handle modal clicks to close them
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal') && !e.target.classList.contains('verification-modal')) {
        e.target.style.display = 'none';
      }
    });
  </script>
</body>
</html>
